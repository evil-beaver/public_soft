<modification>
    <name> Rest API opencart Module</name>
    <version>1.0</version>
    <author>Your Name</author>
    <link>https://yourwebsite.com</link>
    <code>api_clients</code>

    <!-- Добавляем пункт меню в админке -->
    <file path="admin/controller/common/column_left.php">
        <operation>
            <search><![CDATA[if ($this->user->hasPermission('access', 'extension/module')) {]]></search>
            <add position="after"><![CDATA[
                if ($this->user->hasPermission('access', 'extension/module/api_clients')) {
                    $module[] = array(
                        'name'     => 'API Clients',
                        'href'     => $this->url->link('extension/module/api_clients', 'user_token=' . $this->session->data['user_token'], true),
                        'children' => array()
                    );
                }
            ]]></add>
        </operation>
    </file>

    <!-- Обновляем логику установки -->
    <file path="admin/model/setting/setting.php">
        <operation>
            <search><![CDATA[public function deleteSetting($code, $store_id = 0) {]]></search>
            <add position="before"><![CDATA[
                public function installModule($code) {
                    // Создаём директорию для хранения данных
                    $data_path = DIR_STORAGE . 'api_data/';
                    if (!is_dir($data_path)) {
                        mkdir($data_path, 0755, true);
                    }

                    // Создаём начальные файлы
                    $clients_file = $data_path . 'clients.json';
                    if (!file_exists($clients_file)) {
                        file_put_contents($clients_file, json_encode([], JSON_PRETTY_PRINT));
                    }

                    $order_fields_file = $data_path . 'order_fields.json';
                    if (!file_exists($order_fields_file)) {
                        $fields = [
                            ['field_name' => 'customer_name', 'is_required' => true],
                            ['field_name' => 'email', 'is_required' => true],
                            ['field_name' => 'phone', 'is_required' => false],
                        ];
                        file_put_contents($order_fields_file, json_encode($fields, JSON_PRETTY_PRINT));
                    }
                }

                public function uninstallModule($code) {
                    // Удаляем директорию и файлы данных
                    $data_path = DIR_STORAGE . 'api_data/';
                    if (is_dir($data_path)) {
                        array_map('unlink', glob($data_path . '*'));
                        rmdir($data_path);
                    }
                }
            ]]></add>
        </operation>
    </file>

    <!-- Обновляем контроллеры -->
    <file path="admin/controller/extension/module/api_clients.php">
        <operation>
            <add><![CDATA[
<?php
class ControllerExtensionModuleApiClients extends Controller {
    private $data_file = DIR_STORAGE . 'api_data/clients.json';

    public function index() {
        $data['clients'] = json_decode(file_get_contents($this->data_file), true) ?: [];
        $this->response->setOutput($this->load->view('extension/module/api_clients', $data));
    }

    public function addClient() {
        $clients = json_decode(file_get_contents($this->data_file), true) ?: [];
        $clients[] = [
            'client_id' => count($clients) + 1,
            'client_name' => $this->request->post['name'],
            'client_secret' => md5(uniqid()),
            'status' => 1,
            'date_added' => date('Y-m-d H:i:s'),
        ];
        file_put_contents($this->data_file, json_encode($clients, JSON_PRETTY_PRINT));
        $this->response->redirect($this->url->link('extension/module/api_clients', 'user_token=' . $this->session->data['user_token'], true));
    }
}
            ]]></add>
        </operation>
    </file>
</modification>
